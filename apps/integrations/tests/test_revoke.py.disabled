from django.urls import reverse
from django.contrib.auth import get_user_model
from rest_framework.test import APITestCase
from unittest.mock import patch
from apps.integrations.models import ExternalAccount


class RevocationTests(APITestCase):
    print(f"DEBUG: Module name is {__name__}")
    def setUp(self):
        User = get_user_model()
        self.user = User.objects.create_user(username='tester', password='pass')
        self.client.login(username='tester', password='pass')

    def _create_account(self, provider, refresh_token='r_tok', access_token='a_tok'):
        return ExternalAccount.objects.create(
            user=self.user,
            provider=provider,
            provider_user_id='puid',
            access_token=access_token,
            refresh_token=refresh_token,
        )

    @patch('apps.integrations.utils.requests.post')
    def test_delete_proceeds_when_revocation_fails_and_flag_false(self, mock_post):
        mock_post.return_value.status_code = 400
        acct = self._create_account('googlefit')
        url = reverse('externalaccount-detail', args=[acct.pk])
        resp = self.client.delete(url)
        self.assertEqual(resp.status_code, 204)
        self.assertFalse(ExternalAccount.objects.filter(pk=acct.pk).exists())

    @patch('apps.integrations.utils.requests.post')
    def test_delete_aborted_when_revocation_fails_and_flag_true(self, mock_post):
        # Enable the setting for this test
        from django.test import override_settings

        mock_post.return_value.status_code = 400
        acct = self._create_account('googlefit')
        url = reverse('externalaccount-detail', args=[acct.pk])
        with override_settings(FAIL_REVOKE_ON_DISCONNECT=True):
            resp = self.client.delete(url)
            self.assertEqual(resp.status_code, 502)
            self.assertTrue(ExternalAccount.objects.filter(pk=acct.pk).exists())

    @patch('apps.integrations.utils.requests.post')
    def test_delete_succeeds_when_revocation_succeeds_and_flag_true(self, mock_post):
        from django.test import override_settings
        mock_post.return_value.status_code = 200
        acct = self._create_account('googlefit')
        url = reverse('externalaccount-detail', args=[acct.pk])
        with override_settings(FAIL_REVOKE_ON_DISCONNECT=True):
            resp = self.client.delete(url)
            self.assertEqual(resp.status_code, 204)
            self.assertFalse(ExternalAccount.objects.filter(pk=acct.pk).exists())

    @patch('apps.integrations.utils.requests.post')
    def test_fitbit_revocation_called_with_basic_auth_and_deletes(self, mock_post):
        import os, base64
        mock_post.return_value.status_code = 200
        # set FITBIT client envs
        os.environ['FITBIT_CLIENT_ID'] = 'fitbit-client'
        os.environ['FITBIT_CLIENT_SECRET'] = 'fitbit-secret'
        acct = self._create_account('fitbit', refresh_token='r_tok_fit', access_token='a_tok_fit')
        url = reverse('externalaccount-detail', args=[acct.pk])
        resp = self.client.delete(url)
        self.assertEqual(resp.status_code, 204)
        self.assertFalse(ExternalAccount.objects.filter(pk=acct.pk).exists())
        # verify requests.post called with correct URL and headers
        self.assertTrue(mock_post.called)
        call_args = mock_post.call_args
        called_url = call_args[0][0]
        called_headers = call_args[1].get('headers', {})
        called_data = call_args[1].get('data', {})
        self.assertEqual(called_url, 'https://api.fitbit.com/oauth2/revoke')
        self.assertIn('Authorization', called_headers)
        auth_value = called_headers['Authorization']
        self.assertTrue(auth_value.startswith('Basic '))
        b64 = auth_value.split(' ', 1)[1]
        decoded = base64.b64decode(b64.encode()).decode()
        self.assertEqual(decoded, f"{os.environ['FITBIT_CLIENT_ID']}:{os.environ['FITBIT_CLIENT_SECRET']}")
        self.assertEqual(called_data.get('token'), 'r_tok_fit' or 'a_tok_fit')

    @patch('apps.integrations.utils.requests.post')
    def test_fitbit_revocation_failure_and_flag_true_aborts(self, mock_post):
        import os
        mock_post.return_value.status_code = 400
        os.environ['FITBIT_CLIENT_ID'] = 'fitbit-client'
        os.environ['FITBIT_CLIENT_SECRET'] = 'fitbit-secret'
        acct = self._create_account('fitbit', refresh_token='r_tok_fit', access_token='a_tok_fit')
        url = reverse('externalaccount-detail', args=[acct.pk])
        from django.test import override_settings
        with override_settings(FAIL_REVOKE_ON_DISCONNECT=True):
            resp = self.client.delete(url)
            self.assertEqual(resp.status_code, 502)
            self.assertTrue(ExternalAccount.objects.filter(pk=acct.pk).exists())
